<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
			<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

		gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <title>Codable Routing</title>
    <link rel="icon" type="image/png" href="../../assets/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../../assets/favicon-16x16.png" sizes="16x16" />
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/dist/docs.css">
  </head>
<body>
  <section class="docs-grid-container">
    <aside id="sidebar" class="docs-item-1 docs-sidebar">
      <h1 class="docs-title"><a href="/index.html">KITURA <span class="blue-text">DOCS</span></a></h1>
      <div class="underline-title"></div>
      <ul class="sidebar-list">
        <li class="sidebar-item collapsible">Getting Started</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../getting-started/installation-mac.html">Install Swift for macOS</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/installation-linux.html">Install Swift for Linux</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/hello-world.html">Hello World</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/create-server.html">Create a server</a></li>

          <li class="nested-sidebar-item"><a href="../getting-started/update-package.html">Adding Packages</a></li>
        </ul>
        <li class="sidebar-item collapsible">Logging</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../logging/logging.html">What is Logging?</a></li>
          <li class="nested-sidebar-item"><a href="../logging/helium-logger.html">Helium Logger</a></li>
        </ul>
        <li class="sidebar-item collapsible">Routing</li>
        <ul class="nested-sidebar-list content" style="max-height: 250px;">
          <li class="nested-sidebar-item"><a href="../routing/routing.html">What is routing?</a></li>
          <li class="nested-sidebar-item active"><a href="../routing/codable-routing.html">Codable routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/raw-routing.html">Raw routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/open-api.html">OpenAPI</a></li>
        </ul>
        <li class="sidebar-item collapsible">Databases</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../databases/databases.html">What are Databases?</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery-orm.html">SQL: ORM</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery.html">SQL: Kuery</a></li>
          <li class="nested-sidebar-item"><a href="../databases/couchdb.html">NoSQL: CouchDB</a></li>
        </ul>
        <li class="sidebar-item collapsible">Sessions</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../sessions/sessions.html">What are Sessions?</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/kitura-session.html">Raw Routing Session</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/type-safe-session.html">Codable Routing Session</a></li>
        </ul>
        <li class="sidebar-item collapsible">Authentication</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../authentication/authentication.html">What is Authentication?</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/typesafe-auth.html">Basic Authentication</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/jwt-auth.html">JSON Web Tokens</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/fb-google-oauth2.html">OAuth 2.0 with Facebook/Google</a></li>
        </ul>
        <li class="sidebar-item collapsible">Web Application</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../templating/templating.html">What are Web Applications?</a></li>
          <li class="nested-sidebar-item"><a href="../templating/static-file-server.html">Static File Server</a></li>
          <li class="nested-sidebar-item"><a href="../templating/stencil.html">Stencil</a></li>
          <li class="nested-sidebar-item"><a href="../templating/markdown.html">Markdown</a></li>
        </ul>
        <li class="sidebar-item collapsible">WebSockets</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../websockets/websockets.html">What are WebSockets?</a></li>
          <li class="nested-sidebar-item"><a href="../websockets/echo-server.html">Echo Server</a></li>
        </ul>
        <li class="sidebar-item collapsible">Deploying</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../deploying/monitoring.html">Monitoring</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/ssl.html">Enabling SSL/TLS</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/docker.html">Docker</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/kubernetes.html">Kubernetes</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/cloud-foundry.html">Cloud Foundry</a></li>
        </ul>
        <li class="sidebar-item collapsible">Configuring</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../configuring/enabling-nio.html">Enabling SwiftNIO</a></li>
        </ul>
      </ul>
    </aside>
    <div id="burgerIcon" class="burger-icon" onclick="showSidebar()">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </div>
    <div class="docs-item-2 search-container">
    </div>
    <nav class="docs-item-3 docs-nav">
      <button id="api-button" class="apiref-button" type="button" name="button" onclick="window.open('https://ibm-swift.github.io/Kitura/')">API Reference</button>
      <a class="nav-item" target="_blank" href="http://slack.kitura.io/">Need help?</a>
      <a class="nav-item" target="_blank" href="https://github.com/IBM-Swift/kitura.io/issues">Found an issue?</a>
    </nav>
    <div id="doc-container" class="docs-item-4 docs-window">
      <main>
        <h1 class="heading-1">Codable Routing</h1>
        <p class="block-text">Codable routing is where the router handlers are just normal functions you might define elsewhere in your code;
             they take struct or class types as parameters, and respond with struct or class types via a completion handler.
              The only requirement is that those types conform to the Codable protocol introduced in Swift 4 (hence the name).</p>
        <p class="block-text">In this guide, we will show you how to set up Codable routes on your server.
             We will store a Swift object that is sent via a POST request. We will then return that object when a user sends a GET request.</p>
        <div class="info">
          <p>If you don't have a Kitura server, follow our <a target="_blank" href="https://www.kitura.io/docs/getting-started/create-server.html"> Create a server</a> guide.</p>
        </div>
        <h2 class="heading-2"><span class="blue-text">Step 1:</span> Create a file to contain the routes</h2>
        <p>We are going to create a new file, where we will define the routes for this guide. </p>
        <p>Open your <strong>Application.swift</strong> file:</p>
        <pre><code>open Sources/Application/Application.swift</code></pre>
        <p> Inside the <strong>postInit()</strong> function add: </p>
        <pre><code class="language-swift">initializeCodableRoutes(app: self)</code></pre>
        <p>Create a new file, called <strong>CodableRoutes.swift</strong>:</p>
        <pre><code>touch Sources/Application/Routes/CodableRoutes.swift</code></pre>
        <p>Open your <strong>CodableRoutes.swift</strong> file:</p>
        <pre><code>open Sources/Application/Routes/CodableRoutes.swift</code></pre>
        <p>Inside this file, add the framework for our routes code: </p>
        <pre><code class="language-swift">import KituraContracts

func initializeCodableRoutes(app: App) {
    // Register routes here
}
extension App {
    static var codableStore = [Book]()
    // Write handlers here
}</code></pre>
        <p>This code contains two sections. The first is the <strong>initializeCodableRoutes</strong> function.
            This will be run after the application has been initialized and is where we register routes on our router.
            The second is the <strong>App</strong> extension. This is where we write the logic to handle requests.</p>
        <p>We also have a <strong>codableStore</strong> where we will store an array of objects. We will use the <a target="_blank" href="../routing/routing.html#bookmodel"> Book model from the routing guide</a>, however you could use any Codable type.</p>
        <p>Finally, we have imported the KituraContracts library, which is pulled in with Kitura, as it contains the shared type definition for <strong>RequestError</strong> which we will use in the next step.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 2:</span> Create a POST Codable Route</h2>
        <p>We will now create a POST route that will recieve a Codable type and store it in our <strong>codableStore</strong>.</p>
        <p>Inside the <strong>initializeCodableRoutes</strong> function add:</p>
        <pre><code class="language-swift">app.router.post("/codable", handler: app.postHandler)</code></pre>
        <p>This code will register a POST endpoint on our router that will handle any POST requests made to "/codable".</p>
        <p>This will not compile as we haven't actually implemented the <strong>postHandler</strong> yet, so let's go ahead and do that.</p>
        <p>The <strong>postHandler</strong> is a block of code, called a closure, that is executed when a POST request is made to "/codable".</p>
        <p> Inside the <strong>App</strong> extension add: </p>
        <pre><code class="language-swift">func postHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
    App.codableStore.append(book)
    completion(book, nil)
}</code></pre>
        <p>Here the postHandler accepts an object of type <strong>Book</strong> and responds using an asynchronous completion handler.
             The handler then stores the received book in the <strong>codableStore</strong> and returns the book in the completion to indicate success.</p>
        <div class="info">
            <p>The input parameter and the response parameter in the completion handler can be any Swift type, as long as it conforms to Codable.</p>
        </div>
        <p>We can now successfully compile the project!</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 3:</span> Test the POST route</h2>
        <p>With the project now compiling we can start the server.</p>
        <div class="info">
          <p>Kitura has support for OpenAPI which makes testing Codable routes easy and provides a UI for testing.
             You can add OpenAPI to your server using our <a target="_blank" href="https://www.kitura.io/docs/routing/open-api.html"> OpenAPI guide</a>.</p>
        </div>
        <p>To test the route using curl, open Terminal and enter the following:</p>
        <pre><code>curl -X POST \
  http://localhost:8080/codable \
  -H 'content-type: application/json' \
  -d '{
    "id": 0,
    "title": "A Game of Thrones",
    "price": 14.99,
    "genre": "Fantasy"
  }'
</code></pre>
        <p>If the Codable route was created correctly we should see the following:</p>
        <pre><code>{"id": 0,"title":"A Game of Thrones","price":14.99,"genre":"Fantasy"}</code></pre>
        <p>We have just successfully posted a book to the server and had it returned.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 4: </span>Create a GET ALL Codable Route</h2>
        <p>We register a GET route in a similar way to the POST route.</p>
        <p>Inside the <strong>initializeCodableRoutes</strong> function add:</p>
        <pre><code class="language-swift">app.router.get("/codable", handler: app.getAllHandler)</code></pre>
        <p>Just like before we now need to define the handler.</p>
        <p> Inside the <strong>App</strong> extension add: </p>
        <pre><code class="language-swift">func getAllHandler(completion: ([Book]?, RequestError?) -> Void) {
    completion(App.codableStore, nil)
}</code></pre>
        <p>You may have noticed that the completion here is expecting an array of books, this is because our route does not provide an identifier, so we retrieve all of the books.</p>
        <p>Now we can restart our server to test our new endpoint.</p>
        <p>Once the server is running, post a book using the curl command in Step 3.</p>
        <p>Open a browser at:</p>
        <p><a href="http://localhost:8080/codable" target="_blank">localhost:8080/codable</a></p>
        <p>This will make a GET request to the server and we should see the book we posted:</p>
        <pre><code>[{
  "id": 0,
  "title": "A Game of Thrones",
  "price": 14.99,
  "genre": "Fantasy"
}]</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 5:</span> Create a GET ONE Codable Route</h2>
        <p>Now we will create another GET route. This time we will register a handler for GET requests on "/codable/&lt;id&gt;" which will allow an identifier, &lt;id&gt; to be sent from the client which will identify the book to return information for.</p>
        <p>Inside the <strong>initializeCodableRoutes</strong> function add:</p>
        <pre><code class="language-swift">app.router.get("/codable", handler: app.getOneHandler)</code></pre>
        <p>Just like before we now need to define the handler.</p>
        <p> Inside the <strong>App</strong> extension add: </p>
        <pre><code class="language-swift">func getOneHandler(id: Int, completion: (Book?, RequestError?) -> Void) {
    guard id < App.codableStore.count, id >= 0 else {
        return completion(nil, .notFound)
    }
    completion(App.codableStore[id], nil)
}</code></pre>
        <p>In the handler, we are provided with an identifier <strong>id</strong>. This is the value following our route and can be either an <strong>Int</strong> or a <strong>String</strong>, in our example we use <strong>Int</strong>, as our model contains an identifier of type <strong>Int</strong>.
        We then use this identifier to return a single <strong>Book.</strong></p>
        <p>Now we can restart our server to test our new endpoint.</p>
        <p>Once the server is running, open the browser at:</p>
        <p><a href="http://localhost:8080/codable/0" target="_blank">localhost:8080/codable/0</a></p>
        <p>This will make a GET request to the server and we should see the first book in JSON format:</p>
        <pre><code>{
  "id": 0,
  "title": "A Game of Thrones",
  "price": 14.99,
  "genre": "Fantasy"
}</code></pre>
      <p>Now we will POST a second book to the server:</p>
      <pre><code>curl -X POST \
http://localhost:8080/codable \
-H 'content-type: application/json' \
-d '{
  "id": 0,
  "title": "Harry Potter",
  "price": 10.00,
  "genre": "Fantasy"
}'</code></pre>
        <p>Then open the browser at:</p>
        <p><a href="http://localhost:8080/codable/1" target="_blank">localhost:8080/codable/1</a></p>
        <p>This will make a new GET request to the server and we should see the second book in JSON format:</p>
        <pre><code>{"id": 1,"title":"Harry Potter","price":10.00,"genre":"Fantasy"}</code></pre>
        <div class="underline"></div>

        <h2 class="heading-2"><span class="blue-text">Step 6:</span> Adding thread safety (Optional)</h2>
        <p class="block-text">Kitura route handlers are asynchronous.
            If threads from different routes try to change the same object at the same time they will crash.
            To prevent these collisions in our example, we can serialize access to the <strong>codableStore</strong>.</p>
        <div class="info">
          <p>If you have completed the <a href="../routing/raw-routing.html" target="_blank">Raw Routing guide</a>, you will already have the execute function.</p>
        </div>
        <p>Open your <strong>Application.swift</strong> file:</p>
        <pre><code>open Sources/Application/Application.swift</code></pre>
        <p>Add <strong>Dispatch</strong> to the import statements:</p>
        <pre><code class="language-swift">import Dispatch</code></pre>
        <p>Inside the <strong>App</strong> class, add a <strong>DispatchQueue</strong>: </p>
        <pre><code class="language-swift">let workerQueue = DispatchQueue(label: "worker")</code></pre>
        <p>At the end of the <strong>App</strong> class, add a helper function for atomically executing code:</p>
        <pre><code class="language-swift">func execute(_ block: (() -> Void)) {
    workerQueue.sync {
        block()
    }
}</code></pre>
        <p>Back in <strong>CodableRoutes.swift</strong>, we wrap the code in our handlers with this execute function.</p>
        <p>Your completed <strong>CodableRouting.swift</strong> should now look as follows:</p>
    <pre><code class="language-swift">import KituraContracts

func initializeCodableRoutes(app: App) {
    app.router.post("/codable", handler: app.postHandler)
    app.router.get("/codable", handler: app.getAllHandler)
    app.router.get("/codable", handler: app.getOneHandler)
}
extension App {
    static var codableStore = [Book]()

    func postHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
        execute {
            App.codableStore.append(book)
        }
        completion(book, nil)
    }

    func getAllHandler(completion: ([Book]?, RequestError?) -> Void) {
        execute {
            completion(App.codableStore, nil)
        }
    }
    func getOneHandler(id: Int, completion: (Book?, RequestError?) -> Void) {
        execute {
            guard id < App.codableStore.count, id >= 0 else {
                return completion(nil, .notFound)
            }
            completion(App.codableStore[id], nil)
        }
    }
}</code></pre>
    <p>We can continue to make POST and GET requests from our bookstore.</p>
    <p>However, if the server is restarted, all the data will be lost and we will have an empty array again.</p>
    <p>In the Database Guide we will look to resolve this issue and add persistence.</p>
        <h2 class="heading-2">Next steps</h2>
        <p><span class="blue-text bold"><a onclick="setActiveSidebarElementForParent('openapi')" href="open-api.html#">Add Kitura OpenAPI:</a></span> Provides a UI for viewing information about Codable routes.</p>
        <!-- <p><span class="blue-text bold">Add Sessions:</span> Some blurb about Sessions</p>
        <p><span class="blue-text bold">Add Authentication:</span> Some blurb about Authentication</p> -->
      </main>
    </div>
    <div id="top-page" class="top-page">
      <a href="#">Back to top</a>
    </div>
  </section>
  <script src="../../scripts/prism.js"></script>
  <script type="text/javascript" src="../../scripts/learn.js"></script>
</body>
</html>
