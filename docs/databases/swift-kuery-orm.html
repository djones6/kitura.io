<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
			<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-73924704-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

		gtag('config', 'UA-73924704-2', { 'anonymize_ip': true });
</script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <title>Swift Kuery ORM</title>
    <link rel="icon" type="image/png" href="../../assets/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../../assets/favicon-16x16.png" sizes="16x16" />
    <link href=“https://fonts.googleapis.com/css?family=IBM+Plex+Sans” rel=“stylesheet”>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/dist/docs.css">
  </head>
<body>
  <section class="docs-grid-container">
    <aside id="sidebar" class="docs-item-1 docs-sidebar">
      <h1 class="docs-title"><a href="/index.html">KITURA <span class="blue-text">DOCS</span></a></h1>
      <div class="underline-title"></div>
      <ul class="sidebar-list">
        <li class="sidebar-item collapsible">Getting Started</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../getting-started/installation-mac.html">Install Swift for macOS</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/installation-linux.html">Install Swift for Linux</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/hello-world.html">Hello World</a></li>
          <li class="nested-sidebar-item"><a href="../getting-started/create-server.html">Create a server</a></li>

          <li class="nested-sidebar-item"><a href="../getting-started/update-package.html">Adding Packages</a></li>
        </ul>
        <li class="sidebar-item collapsible">Logging</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../logging/logging.html">What is Logging?</a></li>
          <li class="nested-sidebar-item"><a href="../logging/helium-logger.html">Helium Logger</a></li>
        </ul>
        <li class="sidebar-item collapsible">Routing</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../routing/routing.html">What is routing?</a></li>
          <li class="nested-sidebar-item"><a href="../routing/codable-routing.html">Codable routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/raw-routing.html">Raw routing</a></li>
          <li class="nested-sidebar-item"><a href="../routing/open-api.html">OpenAPI</a></li>
        </ul>
        <li class="sidebar-item collapsible">Databases</li>
        <ul class="nested-sidebar-list content" style="max-height: 250px;">
          <li class="nested-sidebar-item"><a href="../databases/databases.html">What are Databases?</a></li>
          <li class="nested-sidebar-item active"><a href="../databases/swift-kuery-orm.html">SQL: ORM</a></li>
          <li class="nested-sidebar-item"><a href="../databases/swift-kuery.html">SQL: Kuery</a></li>
          <li class="nested-sidebar-item"><a href="../databases/couchdb.html">NoSQL: CouchDB</a></li>
        </ul>
        <li class="sidebar-item collapsible">Sessions</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../sessions/sessions.html">What are Sessions?</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/kitura-session.html">Raw Routing Session</a></li>
          <li class="nested-sidebar-item"><a href="../sessions/type-safe-session.html">Codable Routing Session</a></li>
        </ul>
        <li class="sidebar-item collapsible">Authentication</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../authentication/authentication.html">What is Authentication?</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/typesafe-auth.html">Basic Authentication</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/jwt-auth.html">JSON Web Tokens</a></li>
          <li class="nested-sidebar-item"><a href="../authentication/fb-google-oauth2.html">OAuth 2.0 with Facebook/Google</a></li>
        </ul>
        <li class="sidebar-item collapsible">Web Application</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../templating/templating.html">What are Web Applications?</a></li>
          <li class="nested-sidebar-item"><a href="../templating/static-file-server.html">Static File Server</a></li>
          <li class="nested-sidebar-item"><a href="../templating/stencil.html">Stencil</a></li>
          <li class="nested-sidebar-item"><a href="../templating/markdown.html">Markdown</a></li>
        </ul>
        <li class="sidebar-item collapsible">WebSockets</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../websockets/websockets.html">What are WebSockets?</a></li>
          <li class="nested-sidebar-item"><a href="../websockets/echo-server.html">Echo Server</a></li>
        </ul>
        <li class="sidebar-item collapsible">Deploying</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../deploying/monitoring.html">Monitoring</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/ssl.html">Enabling SSL/TLS</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/docker.html">Docker</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/kubernetes.html">Kubernetes</a></li>
          <li class="nested-sidebar-item"><a href="../deploying/cloud-foundry.html">Cloud Foundry</a></li>
        </ul>
        <li class="sidebar-item collapsible">Configuring</li>
        <ul class="nested-sidebar-list content">
          <li class="nested-sidebar-item"><a href="../configuring/enabling-nio.html">Enabling SwiftNIO</a></li>
        </ul>
      </ul>
    </aside>
    <div id="burgerIcon" class="burger-icon" onclick="showSidebar()">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </div>
    <div class="docs-item-2 search-container">
    </div>
    <nav class="docs-item-3 docs-nav">
      <button id="api-button" class="apiref-button" type="button" name="button" onclick="window.open('https://ibm-swift.github.io/Kitura/')">API Reference</button>
      <a class="nav-item" target="_blank" href="http://slack.kitura.io/">Need help?</a>
      <a class="nav-item" target="_blank" href="https://github.com/IBM-Swift/kitura.io/issues">Found an issue?</a>
    </nav>
    <div id="doc-container" class="docs-item-4 docs-window">
      <main>
        <h1 class="heading-1">Swift Kuery ORM</h1>
        <p class="block-text"><a href="https://github.com/IBM-Swift/Swift-Kuery-ORM" target="_blank">Swift-Kuery-ORM</a> is an ORM (Object Relational Mapping) library for Swift built on top of <a target="_blank" href="https://github.com/IBM-Swift/Swift-Kuery">Swift Kuery</a>, using it allows you to simplify the persistence of model objects with your server.</p>
        <p class="block-text">In this guide we will show you how to save and retrieve a <strong>Codable</strong> Swift model from a database (in this case PostgreSQL) using the ORM.<p/>
        <p class="block-text">This guide uses the ORM with <a onclick="setActiveSidebarElementForParent('codable-routing')" href="../routing/codable-routing.html">codable routes</a>, however, the ORM also works with Kitura's <a onclick="setActiveSidebarElementForParent('raw-routing')" href="../routing/raw-routing.html#">raw routing</a>.</p>
        <div class="info">
          <p>Support for nested <strong>Codable</strong> types (models, structs, arrays etc.) is not currently available in the ORM. Support for simple nesting will be added prior to releasing V1.0, more complex nesting will be added for V2.0.</p>
        </div>
        <h2 class="heading-2"><span class="blue-text">Step 1:</span> Define the ORM routes</h2>
        <p>We are going to create a new file in our project for the ORM routes.</p>
        <div class="info">
            <p>If you don't have a server, follow our <a target="_blank" href="https://www.kitura.io/docs/getting-started/create-server.html"> Create a server</a> guide.</p>
        </div>
        <p>Open your <strong>Application.swift</strong> file:</p>
        <pre><code>open Sources/Application/Application.swift</code></pre>
        <p> Inside the <strong>postInit()</strong> function add: </p>
        <pre><code class="language-swift">initializeORMRoutes(app: self)</code></pre>
        <p>Create a new file called <strong>ORMRoutes.swift</strong> to define the ORM routes in:</p>
        <pre><code>touch Sources/Application/Routes/ORMRoutes.swift</code></pre>
        <p>Open the <strong>ORMRoutes.swift</strong> file:</p>
        <pre><code>open Sources/Application/Routes/ORMRoutes.swift</code></pre>
        <p>Inside this file we will add the code for our ORM routes:</p>
        <pre><code class="language-swift">import KituraContracts

func initializeORMRoutes(app: App) {
    // Connect to database here
    app.router.post("/orm", handler: app.saveHandler)
    app.router.get("/orm", handler: app.findAllHandler)
    app.router.get("/orm", handler: app.findOneHandler)
}
extension App {
    func saveHandler(book: Book, completion: (Book?, RequestError?) -> Void) {
        // Save book here
    }

    func findAllHandler(completion: ([Book]?, RequestError?) -> Void) {
        // Get all books here
    }

    func findOneHandler(id: Int, completion: (Book?, RequestError?) -> Void) {
        // Get one book here
    }
}</code></pre>
        <p>We have defined three routes on the "/orm" endpoint. One to handle POST requests, one to handle GET requests with an identifier and one to handle GET requests without an identifier.</p>
        <p>The routes in this guide are using the<a target="_blank" href="../routing/routing.html#bookmodel"> Book model from the routing guide</a>, however you could use any Codable type.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 2:</span> Add the ORM to the project's dependencies</h2>
        <div class="info">
          <p>You can use any of the other database plugins supported by <a href="https://github.com/IBM-Swift/Swift-Kuery" target="_blank">Swift-Kuery</a>, however, the rest of this guide is written to work with the <a href="https://github.com/IBM-Swift/Swift-Kuery-PostgreSQL" target="_blank">Swift-Kuery-PostgreSQL</a> plugin.</p>
        </div>
        <p>To use the ORM, we need to <a target="_blank" href="https://github.com/IBM-Swift/Swift-Kuery-ORM#update-your-packageswift-file"> add Swift-Kuery-ORM</a> and <a target="_blank" href="https://github.com/IBM-Swift/Swift-Kuery-PostgreSQL#add-dependencies"> add Swift-Kuery-PostgreSQL</a> to your dependencies.</p>
        <p>Next, we import the ORM library and our chosen plugin to the project:</p>
        <pre><code class="language-swift">import SwiftKueryORM
import SwiftKueryPostgreSQL</code></pre>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 3:</span> Update our Model</h2>
        <p>The key component of the ORM is the <strong>Model</strong> protocol which extends what <strong>Codable</strong> provides. In order to use the ORM, we need to make <strong>Book</strong> conform to the <strong>Model</strong> protocol.</p>
        <p>We do this using an extension beneath our import statements:</p>
        <pre><code class="language-swift">extension Book: Model { }</code></pre>
        <p>Now that your <strong>Book</strong> struct conforms to <strong>Model</strong>, after you have set up your database connection pool and created a database table, you automatically have access to a slew of convenience functions for your object.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 4:</span> Create a database connection</h2>
        <h3 class="heading-3">Install the PostgreSQL client</h3>
        <p>To use Swift-Kuery-PostgreSQL you need to have the appropriate PostgreSQL C-language client installed.</p>
        <h4 class="heading-4">macOS</h4>
        <p>On macOS we can use Homebrew to install Postgres:</p>
        <pre><code class="language-swift">brew install postgresql</code></pre>
        <h4 class="heading-4">Linux</h4>
        <p>On Linux we can use <strong>apt</strong> to install PostgreSQL:</p>
        <pre><code class="language-swift">sudo apt install postgresql postgresql-contrib</code></pre>
        <p>Linux requires that you <a target="_blank" href="http://postgresguide.com/setup/users.html">create a PostgreSQL user</a>.</p>
        <h3 class="heading-3">Create a PostgreSQL database</h3>
        <p>Now that we have PostgreSQL installed we can create a database:</p>
        <pre><code class="language-swift">createdb bookdb</code></pre>
        <p>Now we're ready to connect to our database from our Kitura server.</p>
        <h3 class="heading-3">Create a PostgreSQL connection pool</h3>
        <p>Inside <strong>initializeORMRoutes</strong>, create a PostgreSQL connection pool:</p>
        <pre><code class="language-swift">let pool = PostgreSQLConnection.createPool(host: "localhost", port: 5432, options: [.databaseName("bookdb")], poolOptions: ConnectionPoolOptions(initialCapacity: 10, maxCapacity: 50))
Database.default = Database(pool)</code></pre>
        <div class="info">
            <p>If you are on Linux, you must provide your username and password in the options for <strong>PostgreSQLConnection.createPool()</strong>.</p>
        </div>
        <h3 class="heading-3">Create a <strong>Book</strong> table</h3>
        <p>Inside <strong>initializeORMRoutes</strong>, create a table in the SQL database that represents our <strong>Book</strong> model:</p>
        <pre><code class="language-swift">do {
    try Book.createTableSync()
} catch {
    print("Failed to create table: \(error)")
}</code></pre>
        <p>To check that a database table called Book has been created, run your Kitura server and then use psql from the command-line as follows:</p>
        <pre><code>psql bookdb
SELECT * FROM "Book";</code></pre>
        <p>This should print the column names of the Book table with no data (i.e. no rows).</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 5:</span> Save an object to the database</h2>
        <p>Now if we want to save a new <strong>Book</strong> object to our database we use the <strong>save()</strong> method.</p>
        <p>In our handler for the POST route we add the following:</p>
        <pre><code class="language-swift">book.save(completion)</code></pre>
        <p>Because we are passing our <strong>completion</strong> closure to an asynchronous function, we need to make <strong>completion</strong> escaping:</p>
        <pre><code class="language-swift">completion: @escaping (Book?, RequestError?)</code></pre>
        <p>The POST handler should look similar to this:</p>
        <pre><code class="language-swift">
func saveHandler(book: Book, completion: @escaping (Book?, RequestError?) -> Void) {
    book.save(completion)
}</code></pre>
        <p>That's all we need to do, with that one line of code any book data posted to the <strong>/orm</strong> endpoint will be stored in the Book table in our database.</p>
        <p>Next we will show how easy it is to retrieve our book data from the database.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 6:</span> Retrieve all the books from the database</h2>
        <p>Next we will retrieve all the data from the book table in our database, to do this we use the <strong>findAll</strong> method.</p>
        <p>The <strong>findAll</strong> method returns an array containing all the books.</p>
        <p>In our <strong>findAllHandler</strong> add the following code:</p>
        <pre><code class="language-swift">Book.findAll(completion)</code></pre>
        <p>As with the <strong>saveHandler</strong>, again we must make the <strong>completion</strong> escaping:</p>
        <pre><code class="language-swift">completion: @escaping ([Book]?, RequestError?)</code></pre>
        <p>The GET handler should look similar to this:</p>
        <pre><code class="language-swift">func findAllHandler(completion: @escaping ([Book]?, RequestError?) -> Void) {
    Book.findAll(completion)
}</code></pre>
        <p>Now that we have defined both a POST and a GET route we can test saving and retrieving a book from the database using curl.</p>
        <div class="info">
          <p>Kitura has support for <a href="https://www.openapis.org" target="_blank">OpenAPI</a> which makes testing Codable routes easy and provides a UI for testing.</p>
          <p>You can add OpenAPI to your server using our <a href="../routing/open-api.html" target="_blank">OpenAPI guide</a>.</p>
        </div>
        <p>Firstly we need to start our Kitura server.</p>
        <p>In the terminal use curl to post a book to our endpoint:</p>
        <pre><code>curl -X POST \
      http://localhost:8080/orm \
      -H 'content-type: application/json' \
      -d '{
        "id": 0,
        "title": "A Game of Thrones",
        "price": 14.99,
        "genre": "Fantasy"
    }'</code></pre>
        <p>You should see the following output:</p>
        <pre><code>{"id": 0,"title":"A Game of Thrones","price":14.99,"genre":"Fantasy"}</code></pre>
        <p>Next we will retrieve our book data.</p>
        <p>Open your browser at:</p>
        <p><a href="http://localhost:8080/orm" target="_blank">localhost:8080/orm</a></p>
        <p>This will make a get request to the server and you should see the book we posted before:</p>
        <pre><code>[{"id": 0,"title":"A Game of Thrones","price":14.99,"genre":"Fantasy"}]</code></pre>
        <p>Now you can restart your Kitura server and the book data will persist in the database. This is one of the many advantages of using a database.</p>
        <div class="underline"></div>
        <h2 class="heading-2"><span class="blue-text">Step 7:</span> Retrieve a single book from the database</h2>
        <p>If we want to retrieve a single book from our database, we use the <strong>find(id:)</strong> method.</p>
        <p>This will return a single object with the provided <strong>id</strong>.</p>
        <p>In our <strong>findOneHandler</strong> add the following code:</p>
        <pre><code class="language-swift">Book.find(id: id, completion)</code></pre>
        <p>As with our previous handler, we must make the <strong>completion</strong> escaping:</p>
        <pre><code class="language-swift">completion: @escaping (Book?, RequestError?)</code></pre>
        <p>The GET one handler should look similar to this:</p>
        <pre><code class="language-swift">
func findOneHandler(id: Int, completion: @escaping (Book?, RequestError?) -> Void) {
    Book.find(id: id, completion)
}</code></pre>
        <p>Test this out by opening your browser at:</p>
        <p><a href="http://localhost:8080/orm/0" target="_blank">localhost:8080/orm/0</a></p>
        <p>This will make a get request to the server for a book with an <strong>id</strong> of 0, so it should return the book we posted previously.</p>
        <p>Your completed routes file, <strong>ORMRoutes.swift</strong>, should look as follows:</p>
    <pre><code class="language-swift">import KituraContracts
import SwiftKueryORM
import SwiftKueryPostgreSQL

extension Book: Model { }
func initializeORMRoutes(app: App) {
    let pool = PostgreSQLConnection.createPool(host: "localhost", port: 5432, options: [.databaseName("bookdb")], poolOptions: ConnectionPoolOptions(initialCapacity: 10, maxCapacity: 50))
    Database.default = Database(pool)
    do {
        try Book.createTableSync()
    } catch {
        print("Failed to create table: \(error)")
    }
    app.router.post("/orm", handler: app.saveHandler)
    app.router.get("/orm", handler: app.findAllHandler)
    app.router.get("/orm", handler: app.findOneHandler)
}
extension App {
    func saveHandler(book: Book, completion: @escaping (Book?, RequestError?) -> Void) {
        book.save(completion)
    }

    func findAllHandler(completion: @escaping ([Book]?, RequestError?) -> Void) {
        Book.findAll(completion)
    }

    func findOneHandler(id: Int, completion: @escaping (Book?, RequestError?) -> Void) {
        Book.find(id: id, completion)
    }
}</code></pre>
        <h2 class="heading-2">Next steps</h2>
        <p><span class="blue-text bold"><a onclick="setActiveSidebarElementForParent('kitura-session')" href="../sessions/sessions.html#">Sessions:</a></span> Learn about sessions and why you might want to use them.</p>
      </main>
    </div>
    <div id="top-page" class="top-page">
      <a href="#">Back to top</a>
    </div>
  </section>
  <script type="text/javascript" src="../../scripts/learn.js"></script>
  <script src="../../scripts/prism.js"></script>
</body>
</html>
