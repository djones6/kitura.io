{"componentChunkName":"component---src-templates-blogs-js","path":"/blogs/type-safe-authentication-using-oauth-tokens","webpackCompilationHash":"a23aaa782308d970cae7","result":{"data":{"blog":{"html":"<h2 id=\"introduction\"><a href=\"#introduction\" aria-label=\"introduction permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction</h2>\n<p>In the 2.4 release of Kitura, we introduced a facility called Type-Safe Middleware, and with it two conforming implementations: Sessions and Credentials.</p>\n<p>If you need to authenticate users of your API, you can use Credentials to specify a middleware when registering your Codable route handler. The handler is invoked only after successful authentication, and an instance of that middleware provides convenient and type-safe access to the user’s profile.</p>\n<p>With the release of Type-Safe Credentials, we provided a type-safe implementation of HTTP Basic authentication. We’re now pleased to introduce two additional forms of authentication: Google and Facebook OAuth tokens.</p>\n<p>In addition, a new  TypeSafeMultiCredentials  protocol allows a single route handler to accept multiple forms of authentication.</p>\n<hr>\n<h2 id=\"authentication-using-oauth-tokens\"><a href=\"#authentication-using-oauth-tokens\" aria-label=\"authentication using oauth tokens permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Authentication using OAuth Tokens</h2>\n<p>A number of service providers support access delegation using OAuth tokens: an ability for a subject to share elements of their user profile with your application, without specifying a password. The token grants the bearer limited access to the subject’s profile – such as to obtain their user id, name or e-mail address.</p>\n<p>The token also acts as proof that the subject is who they claim to be: in order to generate the token, they must have successfully logged into that service provider, and consented to share information with your application.</p>\n<p>Let’s take a look at how we can handle authentication using OAuth tokens from two providers: Google and Facebook.</p>\n<h3 id=\"google-oauth-token\"><a href=\"#google-oauth-token\" aria-label=\"google oauth token permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Google OAuth Token</h3>\n<p>Kitura-CredentialsGoogle makes it simple to create a type-safe middleware that authenticates an incoming request against Google’s OAuth2 userinfo API.</p>\n<p>Start by declaring a dependency on  Kitura-CredentialsGoogle  in your  Package.swift:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> package <span class=\"token operator\">=</span> <span class=\"token function\">Package</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"example\"</span><span class=\"token punctuation\">,</span> dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">package</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/IBM-Swift/Kitura-CredentialsGoogle.git\"</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2.2.0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">target</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"example\"</span><span class=\"token punctuation\">,</span>\n            dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"Kitura\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CredentialsGoogle\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>and import the dependency within your application:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">CredentialsGoogle</span></code></pre></div>\n<p>To authenticate an incoming request that provides a Google OAuth token, you can use the pre-defined  GoogleTokenProfile  type as a middleware when registering a Codable route handler:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\">router<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/protected\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">:</span> <span class=\"token builtin\">GoogleTokenProfile</span><span class=\"token punctuation\">,</span> \n        respondWith<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">GoogleTokenProfile</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">RequestError</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n \n    <span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Alternatively, you can customize this type by defining a conformance to the  TypeSafeGoogleToken  protocol:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">CredentialsGoogle</span>\n \n<span class=\"token keyword\">struct</span> <span class=\"token builtin\">MyGoogleUser</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">TypeSafeGoogleToken</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n    <span class=\"token keyword\">let</span> email<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The  MyGoogleUser  type can then be substituted for the  GoogleTokenProfile  type, and will provide access to only the three fields declared.</p>\n<h3 id=\"facebook-oauth-token\"><a href=\"#facebook-oauth-token\" aria-label=\"facebook oauth token permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Facebook OAuth Token</h3>\n<p>Kitura-CredentialsFacebook defines the equivalent types for authenticating against Facebook’s Graph API.</p>\n<p>Start by declaring a dependency on  Kitura-CredentialsFacebook  in your  Package.swift:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> package <span class=\"token operator\">=</span> <span class=\"token function\">Package</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"example\"</span><span class=\"token punctuation\">,</span> dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">package</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/IBM-Swift/Kitura-CredentialsFacebook.git\"</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">:</span> <span class=\"token string\">\"2.2.0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  targets<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">target</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"example\"</span><span class=\"token punctuation\">,</span> \n            dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"Kitura\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"CredentialsFacebook\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>To authenticate an incoming request that provides a Facebook OAuth token, you can use the pre-defined  FacebookTokenProfile  type as a middleware:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">CredentialsFacebook</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token comment\">// Optionally, specify your Facebook App ID to only accept tokens that were</span>\n<span class=\"token comment\">// issued to your application.</span>\n<span class=\"token builtin\">FacebookTokenProfile</span><span class=\"token punctuation\">.</span>appID <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;your app id>\"</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/protected\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">:</span> <span class=\"token builtin\">FacebookTokenProfile</span><span class=\"token punctuation\">,</span> \n         respondWith<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">FacebookTokenProfile</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">RequestError</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n \n    <span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Again, you can create a custom type by defining a conformance to the  TypeSafeFacebookToken  protocol:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">CredentialsFacebook</span>\n \n<span class=\"token keyword\">struct</span> <span class=\"token builtin\">MyFacebookUser</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">TypeSafeFacebookToken</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n    <span class=\"token keyword\">let</span> email<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token operator\">?</span>\n \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> appID<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;your app id>\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>However, there are some key differences between the Google and Facebook methods that warrant some closer examination:</p>\n<ol>\n<li>Profile contents</li>\n</ol>\n<p>The Google userinfo API provides a fixed profile of information where the subject may optionally choose to share their e-mail address and gender. Requests to Google’s API do not specify which fields are desired: all granted fields are returned.</p>\n<p>In contrast, the Facebook Graph API requires you to specify which fields of a subject’s profile you wish to access. The token determines what subset of these fields have been granted to you by the subject.</p>\n<p>In order to determine which fields should be requested from Facebook, the  TypeSafeFacebook  protocol specifies a list of  validFieldNames  that can be requested from the API. The properties declared by your type are filtered against this list, and the resulting set requested from Facebook. The Facebook response is used to initialize those properties when a user is authenticated. Note that this requires all other properties of your type to be optional.</p>\n<p>The built-in list of field names is likely to be sufficient for most cases but can be overridden by your type if needed.</p>\n<ol start=\"2\">\n<li>App-scoped Identifiers and OAuth AppID verification</li>\n</ol>\n<p>The Facebook  id  field is application-scoped. This means that for a given subject, the value of their id is dependent on the OAuth app that was granted access. The value is still globally unique – meaning that the same value will not be assigned to a different subject in a different application scope.</p>\n<p>In order to establish the user’s identity in the context of your application, we first verify that the supplied token was issued to your App. If the App ID matches, then the token is used to retrieve the subject’s identity. However, if you do not specify a value for  appID , this verification will be skipped and any valid token will be accepted.</p>\n<h3 id=\"caching-of-tokens\"><a href=\"#caching-of-tokens\" aria-label=\"caching of tokens permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Caching of Tokens</h3>\n<p>Rather than querying the service provider upon every incoming request, profiles are cached against their respective token using an in-memory cache.</p>\n<p>Note that there is a behavioral difference between profiles that are defined as structs or classes: if you declare your profile as a struct, changes are not persistent within the cache. If the profile type is a class, then if its properties are changed, the changes will be reflected upon subsequent retrievals from the cache. You should consider using a class type if you need to be able to modify the token profile type.</p>\n<hr>\n<h2 id=\"multiple-authentication-methods\"><a href=\"#multiple-authentication-methods\" aria-label=\"multiple authentication methods permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Multiple authentication methods</h2>\n<p>The above examples show how to require a specific type of authentication to access a resource. However, it is common to accept multiple forms of authentication – such as tokens from multiple authentication providers.</p>\n<p>The  TypeSafeMultiCredentials  protocol provides a way to define a  TypeSafeMiddleware  that permits authentication against a list of methods – an array of  TypeSafeCredentials  types, such as the ones we defined above.</p>\n<p>To use this facility, define a type that conforms to the protocol. This requires that you define an  authenticationMethods  property that lists the permitted authentication methods, and an initializer that takes a  TypeSafeCredentials  parameter. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">Credentials</span>\n \n<span class=\"token keyword\">struct</span> <span class=\"token builtin\">MyMultiAuthedUser</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">TypeSafeMultiCredentials</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>                   <span class=\"token comment\">// Protocol requirement</span>\n    <span class=\"token keyword\">let</span> provider<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>             <span class=\"token comment\">// Protocol requirement</span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>                 <span class=\"token comment\">// Custom property</span>\n    <span class=\"token keyword\">let</span> email<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token operator\">?</span>               <span class=\"token comment\">// Custom, optional property</span>\n \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">var</span> authenticationMethods<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">TypeSafeCredentials</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">Type</span><span class=\"token punctuation\">]</span> \n            <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">MyBasicAuth</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">MyFacebookUser</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">MyGoogleUser</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">]</span>\n \n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>successfulAuth<span class=\"token punctuation\">:</span> <span class=\"token builtin\">TypeSafeCredentials</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> successfulAuth<span class=\"token punctuation\">.</span>id\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>provider <span class=\"token operator\">=</span> successfulAuth<span class=\"token punctuation\">.</span>provider\n \n        <span class=\"token comment\">// Initialize additional properties based on authentication type.</span>\n        <span class=\"token keyword\">switch</span> successfulAuth <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> googleToken <span class=\"token keyword\">as</span> <span class=\"token builtin\">MyGoogleUser</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> googleToken<span class=\"token punctuation\">.</span>name\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>email <span class=\"token operator\">=</span> googleToken<span class=\"token punctuation\">.</span>email\n        <span class=\"token keyword\">case</span> <span class=\"token keyword\">let</span> facebookToken <span class=\"token keyword\">as</span> <span class=\"token builtin\">MyFacebookUser</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> facebookToken<span class=\"token punctuation\">.</span>name\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>email <span class=\"token operator\">=</span> facebookToken<span class=\"token punctuation\">.</span>email\n        <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> successfulAuth<span class=\"token punctuation\">.</span>id    <span class=\"token comment\">// Map id to name for HTTP Basic</span>\n            <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>email <span class=\"token operator\">=</span> <span class=\"token constant\">nil</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Note: the  MyBasicAuth  type represents HTTP Basic authentication, and the code can be found in the previous post: A new kind of Kitura middleware: type-safe and easy to use.</p>\n</blockquote>\n<p>This type can then be used in your Codable route handler, in the same way as before:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\">app<span class=\"token punctuation\">.</span>router<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/multiAuthProfile\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>userProfile<span class=\"token punctuation\">:</span> <span class=\"token builtin\">MyMultiAuthedUser</span><span class=\"token punctuation\">,</span> \n         respondWith<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">MyMultiAuthedUser</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">RequestError</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span>\n \n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Authenticated <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>userProfile<span class=\"token punctuation\">.</span>id<span class=\"token delimiter variable\">)</span></span> using <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>userProfile<span class=\"token punctuation\">.</span>provider<span class=\"token delimiter variable\">)</span></span>\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>userProfile<span class=\"token punctuation\">,</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"client-side-support-with-kiturakit\"><a href=\"#client-side-support-with-kiturakit\" aria-label=\"client side support with kiturakit permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client-side support with KituraKit</h2>\n<p>Support has also been added to KituraKit for supplying token or HTTP Basic credentials. The client now has a  defaultCredentials: ClientCredentials?  property that can be used to specify the credentials that should be supplied for each request from this client.</p>\n<p>As an example, let’s use KituraKit to retrieve the user profile corresponding to a set of credentials, using the /multiAuthProfile route we defined earlier. First we need a type to represent the profile information on the client side:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token builtin\">AuthedUser</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">Codable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> id<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n    <span class=\"token keyword\">let</span> provider<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n    <span class=\"token keyword\">let</span> email<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token operator\">?</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we can define a set of default credentials – in this case, HTTP Basic – to be used when accessing the server:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token builtin\">KituraKit</span>\n \n<span class=\"token comment\">// Create a KituraKit client</span>\n<span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> client <span class=\"token operator\">=</span> <span class=\"token function\">KituraKit</span><span class=\"token punctuation\">(</span>baseURL<span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://localhost:8080\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fatalError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unable to create client\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Assign default credentials to this client</span>\nclient<span class=\"token punctuation\">.</span>defaultCredentials <span class=\"token operator\">=</span> <span class=\"token function\">HTTPBasic</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">:</span> <span class=\"token string\">\"John\"</span><span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">:</span> <span class=\"token string\">\"12345\"</span><span class=\"token punctuation\">)</span>\n \n<span class=\"token comment\">// Make a request using the default credentials</span>\nclient<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/multiAuthProfile\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>returnedItem<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AuthedUser</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> \n        error<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Error</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span> <span class=\"token keyword\">in</span>\n \n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> returnedItem <span class=\"token operator\">=</span> returnedItem <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to retrieve user profile with default credentials: <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>error<span class=\"token delimiter variable\">)</span></span>\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Response with default credentials: <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>returnedItem<span class=\"token delimiter variable\">)</span></span>\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This results in the output:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Response with default credentials: AuthedUser(id: &quot;John&quot;, provider: &quot;HTTPBasic&quot;, name: &quot;John&quot;, email: nil)</code></pre></div>\n<p>You can override the  defaultCredentials  for an individual request by specifying the  credentials: ClientCredentials?  parameter:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">let</span> googleToken <span class=\"token operator\">=</span> <span class=\"token string\">\"abc123\"</span>  <span class=\"token comment\">// Your Google access token</span>\n \n<span class=\"token comment\">// Make a request using specific credentials</span>\nclient<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/multiAuthProfile\"</span><span class=\"token punctuation\">,</span> credentials<span class=\"token punctuation\">:</span> <span class=\"token function\">GoogleToken</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">:</span> googleToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">(</span>returnedItem<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AuthedUser</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Error</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span> <span class=\"token keyword\">in</span>\n \n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> returnedItem <span class=\"token operator\">=</span> returnedItem <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to retrieve user profile with Google token: <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>error<span class=\"token delimiter variable\">)</span></span>\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Response with Google token: <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>returnedItem<span class=\"token delimiter variable\">)</span></span>\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This results in output corresponding to the Google profile information provided via the token:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Response with Google token: AuthedUser(id: &quot;1234567890&quot;, provider: &quot;Google&quot;, name: &quot;John Doe&quot;, email: Optional(&quot;john_doe@invalid.com&quot;))</code></pre></div>\n<p>Finally, if you have set the default credentials but then wish to make a request from that client without supplying credentials, you can specify the  NilCredentials  type:</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// Make a request without providing credentials</span>\nclient<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/multiAuthProfile\"</span><span class=\"token punctuation\">,</span> credentials<span class=\"token punctuation\">:</span> <span class=\"token function\">NilCredentials</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n        <span class=\"token punctuation\">(</span>returnedItem<span class=\"token punctuation\">:</span> <span class=\"token builtin\">AuthedUser</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Error</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span> <span class=\"token keyword\">in</span>\n \n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> error <span class=\"token operator\">=</span> error <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unexpected success without credentials: <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>returnedItem<span class=\"token delimiter variable\">)</span></span>\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Response without credentials: <span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>error<span class=\"token delimiter variable\">)</span></span>\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Which results in:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Response without credentials: 401 : Unauthorized</code></pre></div>","frontmatter":{"path":"/blogs/type-safe-authentication-using-oauth-tokens","title":"Type-Safe Authentication using OAuth tokens","author":"David Jones","date":"2018-06-29"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}