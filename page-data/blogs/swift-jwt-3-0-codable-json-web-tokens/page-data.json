{"componentChunkName":"component---src-templates-blogs-js","path":"/blogs/swift-jwt-3-0-codable-json-web-tokens","webpackCompilationHash":"a23aaa782308d970cae7","result":{"data":{"blog":{"html":"<p>We have just released version 3.0 of Swift-JWT, our library for creating, signing, and verifying JSON Web Tokens. This release adds Codable conformance to the JWTs for easy encoding and decoding. As a result, you can now use JWTs with Kitura’s Codable Routing feature. Furthermore, this release adds support for signing and verifying JWTs using the HMAC hash function. This blog post will explain the new APIs by demonstrating JWT authentication in Codable routes.</p>\n<h2 id=\"what-is-a-json-web-token\"><a href=\"#what-is-a-json-web-token\" aria-label=\"what is a json web token permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is a JSON Web Token?</h2>\n<p>In short, a JWT is a small JSON payload consisting of a Header object, a Claims object and a signature. They are a self-contained way for securely transmitting information between parties. If you would like to know more about JWTs, please read our last blog post announcing the release of our Swift-JWT library or check out jwt.io.</p>\n<hr>\n<h2 id=\"importing-swift-jwt\"><a href=\"#importing-swift-jwt\" aria-label=\"importing swift jwt permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Importing Swift-JWT</h2>\n<p>Let’s start by adding Swift-JWT to the dependencies of a Kitura Server. If you don’t have a project set up, please follow the getting started guide to create one.</p>\n<ol>\n<li>In your Package.swift, add Swift-JWT 3.1.0 to the dependencies and targets:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// dependencies</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">package</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/IBM-Swift/Swift-JWT.git\"</span><span class=\"token punctuation\">,</span> from<span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.1.0\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// targets</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">target</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Application\"</span><span class=\"token punctuation\">,</span> dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"SwiftJWT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre></div>\n<ol start=\"2\">\n<li>Import the SwiftJWT library:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// Inside Application.swift</span>\n<span class=\"token keyword\">import</span> <span class=\"token builtin\">SwiftJWT</span></code></pre></div>\n<hr>\n<h2 id=\"returning-a-jwt-from-a-codable-route\"><a href=\"#returning-a-jwt-from-a-codable-route\" aria-label=\"returning a jwt from a codable route permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Returning a JWT from a Codable route</h2>\n<p>We are going to write a Codable route will received a user’s name and returns a signed JWT String.</p>\n<ol>\n<li>We begin by defining the User and Access token structs:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token builtin\">User</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">Codable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n<span class=\"token punctuation\">}</span>\n \n<span class=\"token keyword\">struct</span> <span class=\"token builtin\">AccessToken</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">Codable</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> accessToken<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"2\">\n<li>Next, we write a Codable route that receives the user’s query and returns a JWT:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// Inside app.postInit()</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/generateJWT\"</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">:</span> loginHandler<span class=\"token punctuation\">)</span>\n \n<span class=\"token comment\">// Inside App</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">loginHandler</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">:</span> <span class=\"token builtin\">User</span><span class=\"token punctuation\">,</span> respondWith<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">AccessToken</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">RequestError</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> jwt <span class=\"token operator\">=</span> <span class=\"token function\">JWT</span><span class=\"token punctuation\">(</span>claims<span class=\"token punctuation\">:</span> <span class=\"token function\">ClaimsStandardJWT</span><span class=\"token punctuation\">(</span>iss<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Kitura\"</span><span class=\"token punctuation\">,</span> sub<span class=\"token punctuation\">:</span> user<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> key <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;PrivateKey>\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>using<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token keyword\">let</span> signedJWT <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span><span class=\"token operator\">?</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>using<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">hs256</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token constant\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>internalServerError<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">AccessToken</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">:</span> signedJWT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This route represents the “Login” route when using JWT authentication.\n– The user provides their name (at which point the server would usually authenticate them).\n– The server takes the user’s information and creates the JWT with their claims.\n– The server signs and encodes the JWT using a private key.\n– The server sends the signed JWT String back to the user</p>\n<ol start=\"3\">\n<li>Run your Kitura server and send a POST request to your route.</li>\n</ol>\n<p>There are many utilities for testing REST APIs, such as Postman. Here we’ll use “curl”, which is a simple command line utility:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -X POST \\\n  http://localhost:8080/generateJWT \\\n  -d &#39;{&quot;name&quot;:&quot;Joe Bloggs&quot;}&#39; \\\n  -H &#39;content-type: application/json&#39;</code></pre></div>\n<p>You should be sent back an access token which looks something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJLaXR1cmEiLCJzdWIiOiJKb2UgQmxvZ2dzIn0.Q2UbWSsU-AecEBBNBWr2NiqJdeV2OQF43yQZhXF0LB4</code></pre></div>\n<p>This is a signed JSON Web Token. If you would like to view its headers and claims, you can decode it at jwt.io/.</p>\n<hr>\n<h2 id=\"authenticating-a-user-using-a-jwt-in-a-codable-route\"><a href=\"#authenticating-a-user-using-a-jwt-in-a-codable-route\" aria-label=\"authenticating a user using a jwt in a codable route permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Authenticating a User using a JWT in a Codable route</h2>\n<p>The signed JWT is the user’s credentials and should be protected in the same way as a password. The user can then send the JWT in their Authentication header so the server knows who is making the request. We will now write a protected route that will only respond to an authenticated user.</p>\n<ol>\n<li>Create a TypeSafeMiddleware to extract the JWT:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">struct</span> <span class=\"token builtin\">TypeSafeJWT</span><span class=\"token operator\">&lt;</span>C<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Claims</span><span class=\"token operator\">></span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">TypeSafeMiddleware</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> jwt<span class=\"token punctuation\">:</span> <span class=\"token constant\">JWT</span><span class=\"token operator\">&lt;</span>C<span class=\"token operator\">></span>\n     \n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">:</span> <span class=\"token builtin\">RouterRequest</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">:</span> <span class=\"token builtin\">RouterResponse</span><span class=\"token punctuation\">,</span> completion<span class=\"token punctuation\">:</span> @escaping <span class=\"token punctuation\">(</span><span class=\"token builtin\">TypeSafeJWT</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">RequestError</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> auth <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> authParts <span class=\"token operator\">=</span> auth<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>separator<span class=\"token punctuation\">:</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span> maxSplits<span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            authParts<span class=\"token punctuation\">.</span><span class=\"token builtin\">count</span> <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n            authParts<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"Bearer\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">let</span> key <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;PrivateKey>\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>using<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">let</span> jwt <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span><span class=\"token operator\">?</span> <span class=\"token constant\">JWT</span><span class=\"token operator\">&lt;</span>C<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>jwtString<span class=\"token punctuation\">:</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>authParts<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> verifier<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">hs256</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">:</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">completion</span><span class=\"token punctuation\">(</span><span class=\"token constant\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>unauthorized<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">completion</span><span class=\"token punctuation\">(</span><span class=\"token function\">TypeSafeJWT</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">:</span> jwt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This middleware will:\n– Read the JWT string from the “Authorization” header of the request.\n– Verify the JWT signature (Ensuring we created the JWT and it hasn’t been altered)\n– Decode the JWT from the string</p>\n<p>Because HMAC is a symmetric algorithm, the JWT is verified using the same key that it was signed with.</p>\n<ol start=\"2\">\n<li>Create a Codable route, protected by JWT authentication:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">// Inside App.PostInit</span>\nrouter<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/protected\"</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">:</span> protected<span class=\"token punctuation\">)</span>\n \n<span class=\"token comment\">// Inside App</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">protected</span><span class=\"token punctuation\">(</span>typeSafeJWT<span class=\"token punctuation\">:</span> <span class=\"token builtin\">TypeSafeJWT</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">ClaimsStandardJWT</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> respondWith<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">User</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">RequestError</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> userName <span class=\"token operator\">=</span> typeSafeJWT<span class=\"token punctuation\">.</span>jwt<span class=\"token punctuation\">.</span>claims<span class=\"token punctuation\">.</span>sub <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token constant\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>internalServerError<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">User</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> userName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"3\">\n<li>Run your Kitura server and send a GET request to the protected route.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -i http://localhost:8080/protected</code></pre></div>\n<p>You should receive an 401 Unauthorized status code back.</p>\n<p>Now send a request using a JWT from the generateJWT route:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -i -H &quot;Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJLaXR1cmEiLCJzdWIiOiJKb2UgQmxvZ2dzIn0.Q2UbWSsU-AecEBBNBWr2NiqJdeV2OQF43yQZhXF0LB4&quot; http://localhost:8080/protected</code></pre></div>\n<p>The name from the JWT will be returned to you. If you change the JWT token or generate one using a different key then it will be rejected by the server.</p>","frontmatter":{"path":"/blogs/swift-jwt-3-0-codable-json-web-tokens","title":"Swift-JWT 3.0: Codable JSON web tokens","author":"Andrew Lees","date":"2018-12-18"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}